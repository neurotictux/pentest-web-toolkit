import { spawn } from 'child_process'
import * as TreeKill from 'tree-kill'
import { RunningProcess } from '../models'

export class CommandRunner {

    private static runningProcesses: RunningProcess[]

    constructor() {
        if (!CommandRunner.runningProcesses)
            CommandRunner.runningProcesses = []
    }

    isRunning(pid: number): boolean {
        return !!CommandRunner.runningProcesses.find(p => p.pid === pid)
    }

    stop(pid: number) {
        const runningProcess = CommandRunner.runningProcesses.find(p => p.pid === pid)
        if (runningProcess) {
            TreeKill(runningProcess.pid)
            CommandRunner.runningProcesses = CommandRunner.runningProcesses.filter(p => p.pid !== pid)
        }
    }

    protected run(command: string, params: string[]) {
        const child = spawn(command, params)
        return {
            pid: child.pid,
            stdout: child.stdout
        }
    }
}